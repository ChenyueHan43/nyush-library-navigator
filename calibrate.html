<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NYUSH Library - 录入与编辑神器</title>
<style>
  body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: #1a1a1a; color: white; }
  #sidebar { width: 350px; background: #2c3e50; padding: 20px; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
  #main { flex-grow: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #34495e; position: relative; }
  canvas { max-width: 100%; max-height: 100%; object-fit: contain; background: white; cursor: crosshair; }
  
  .controls { background: #34495e; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
  button { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
  .btn-import { background: #f39c12; color: white; }
  .btn-export { background: #2980b9; color: white; margin-top: auto; }
  button:hover { opacity: 0.8; }

  #point-list { overflow-y: auto; flex-grow: 1; margin-top: 10px; }
  .point-item { 
    background: #1a252f; padding: 10px; margin-bottom: 8px; border-radius: 4px; 
    font-size: 13px; position: relative; border-left: 5px solid #27ae60;
  }
  .point-item .del-btn { 
    position: absolute; right: 8px; top: 8px; color: #e74c3c; cursor: pointer; font-weight: bold; 
  }
</style>
</head>
<body>

<div id="sidebar">
  <h3>数据编辑器</h3>
  
  <div class="controls">
    <label style="font-size: 12px;">1. 加载底图:</label>
    <select id="mapFile" onchange="loadMap()" style="width:100%; padding:5px;">
      <option value="5f_base.jpg">5th Floor (5F)</option>
      <option value="6f_base.jpg">6th Floor (6F)</option>
    </select>
  </div>

  <div class="controls">
    <label style="font-size: 12px;">2. 导入进度 (可选):</label>
    <button class="btn-import" onclick="document.getElementById('fileInput').click()">Upload locations.csv</button>
    <input type="file" id="fileInput" hidden accept=".csv" onchange="importCSV(this)">
  </div>

  <div id="point-list"></div>

  <button class="btn-export" onclick="exportCSV()">Download Updated CSV</button>
</div>

<div id="main">
  <canvas id="canvas"></canvas>
</div>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const mapSelect = document.getElementById('mapFile');
  let mapImg = new Image();
  let points = [];

  function loadMap() {
    mapImg.src = mapSelect.value;
    mapImg.onload = () => {
      canvas.width = mapImg.width;
      canvas.height = mapImg.height;
      draw();
    };
  }

  // 点击地图新增点位
  canvas.onclick = (e) => {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const x = Math.round((e.clientX - rect.left) * scaleX);
    const y = Math.round((e.clientY - rect.top) * scaleY);

    const name = prompt("地点名称:", "");
    if (!name) return;
    
    const isShelf = confirm("是书架(Shelf)吗？");
    const callStart = prompt("ID/索书号起点:", name);
    const callEnd = isShelf ? prompt("索书号终点:", "") : callStart;

    points.push({
      type: isShelf ? "Shelf" : "Room",
      name: name,
      call_start: callStart,
      call_end: callEnd,
      floor: mapSelect.value.split('f')[0] + "F",
      x: x,
      y: y,
      map_file: mapSelect.value
    });
    
    refresh();
  };

  // 导入 CSV 功能
  function importCSV(input) {
    const file = input.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.split('\n');
      const newPoints = [];
      
      // 跳过表头，遍历每一行
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (cols.length < 8) continue;
        
        // 清理引号和空格
        const clean = (str) => str?.replace(/['"]+/g, '').trim();
        
        newPoints.push({
          type: clean(cols[0]),
          name: clean(cols[1]),
          call_start: clean(cols[2]),
          call_end: clean(cols[3]),
          floor: clean(cols[4]),
          x: parseInt(cols[5]),
          y: parseInt(cols[6]),
          map_file: clean(cols[7])
        });
      }
      points = [...points, ...newPoints];
      // 自动切换到导入数据所在的地图（以第一个点为准）
      if(newPoints.length > 0) {
          mapSelect.value = newPoints[0].map_file;
          loadMap();
      }
      refresh();
    };
    reader.readAsText(file);
  }

  function deletePoint(index) {
    if(confirm("确定删除这个点吗？")) {
      points.splice(index, 1);
      refresh();
    }
  }

  function refresh() {
    renderSidebar();
    draw();
  }

  function draw() {
    ctx.drawImage(mapImg, 0, 0);
    points.forEach((p, index) => {
      // 只绘制当前楼层的点
      if (p.map_file !== mapSelect.value) return;

      ctx.fillStyle = p.type === 'Shelf' ? '#f1c40f' : '#e74c3c';
      ctx.beginPath();
      ctx.arc(p.x, p.y, 45, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "white";
      ctx.lineWidth = 10;
      ctx.stroke();
      
      ctx.fillStyle = "white";
      ctx.font = "bold 50px Arial";
      ctx.fillText(p.name, p.x + 60, p.y + 20);
    });
  }

  function renderSidebar() {
    const list = document.getElementById('point-list');
    list.innerHTML = points.map((p, i) => `
      <div class="point-item" style="border-left-color: ${p.map_file === mapSelect.value ? '#27ae60' : '#95a5a6'}">
        <span class="del-btn" onclick="deletePoint(${i})">✖</span>
        <b>${p.name}</b> <br>
        <small>${p.floor} | ${p.type} | (${p.x}, ${p.y})</small>
      </div>
    `).join('');
  }

  function exportCSV() {
    let csv = "type,name,call_start,call_end,floor,x,y,map_file\n";
    points.forEach(p => {
      csv += `${p.type},"${p.name}",${p.call_start},${p.call_end},${p.floor},${p.x},${p.y},${p.map_file}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'locations.csv';
    a.click();
  }

  loadMap();
</script>
</body>
</html>